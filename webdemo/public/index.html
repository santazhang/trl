<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="./jquery-2.1.1.min.js"></script>
        <link href="./jquery.nouislider-6.1.0.css" rel="stylesheet">
        <script src="./jquery.nouislider-6.1.0.min.js"></script>
        <script type="text/javascript" src="./smoothie-1.23.js"></script>
        <style>
            body {
                font-family: "Verdana";
            }
        </style>
        <script type="text/javascript">

        // Thanks to http://jsbeautifier.org/

        var series_ratio = new TimeSeries();
        var series_abort = new TimeSeries();
        var series_total = new TimeSeries();

        function poll_chart_data() {
            $.get("stat", function(data) {
                var time_now = new Date().getTime();
                var commit_count = data.commit_count;
                var abort_count = data.abort_count;

                var commit_ratio = 0.0;
                if (commit_count + abort_count > 0) {
                    commit_ratio = commit_count / (commit_count + abort_count);
                }

                series_ratio.append(time_now, commit_ratio);
                series_abort.append(time_now, abort_count);
                series_total.append(time_now, commit_count + abort_count);
            });
        }

        var poll_interval = 1000;
        setInterval(poll_chart_data, poll_interval);

        function create_chart() {
            var delay = 1000;

            var ratio_chart = new SmoothieChart({
                millisPerPixel: 100,
                grid: {
                    fillStyle: '#ffffff',
                    strokeStyle: 'rgba(119,119,119,0.4)',
                    sharpLines: true,
                    millisPerLine: 6000,
                    verticalSections: 5
                },
                labels: {
                    fillStyle: '#000000',
                    precision: 0
                },
                maxValue: 1,
                minValue: 0,
                timestampFormatter: SmoothieChart.timeFormatter
            });
            ratio_chart.addTimeSeries(series_ratio, {
                strokeStyle: 'rgba(0, 0, 255, 1)',
                fillStyle: 'rgba(0, 0, 255, 0.4)',
                lineWidth: 1
            });
            ratio_chart.streamTo(document.getElementById("chart-ratio"), delay);

            var tps_chart = new SmoothieChart({
                millisPerPixel: 100,
                grid: {
                    fillStyle: '#ffffff',
                    strokeStyle: 'rgba(119,119,119,0.4)',
                    sharpLines: true,
                    millisPerLine: 6000,
                    verticalSections: 5
                },
                labels: {
                    fillStyle: '#000000',
                    precision: 0
                },
                minValue: 0,
                timestampFormatter: SmoothieChart.timeFormatter,
                yRangeFunction: function(range) {
                    var min = range.min;
                    var max = (Math.ceil(range.max / 100.0) + 1) * 100;
                    return {min: min, max: max};
                }
            });
            tps_chart.addTimeSeries(series_total, {
                strokeStyle: 'rgba(0, 255, 0, 1)',
                fillStyle: 'rgba(0, 255, 0, 0.2)',
                lineWidth: 1
            });
            tps_chart.addTimeSeries(series_abort, {
                strokeStyle: 'rgba(255, 0, 0, 1)',
                fillStyle: 'rgba(255, 0, 0, 0.4)',
                lineWidth: 1
            });
            tps_chart.streamTo(document.getElementById("chart-tps"), delay);
        }

        function init_demo() {
            // init sliders
            $("#slider-active-servers").noUiSlider({
                start: [1],
                step: 1,
                range: {
                    min: [1],
                    max: [5]
                },
                serialization: {
                    lower: [
                        $.Link({
                            target: $("#value-active-servers")
                        })
                    ],
                    format: {decimals: 0}
                }
            });

            $("#slider-active-clients").noUiSlider({
                start: [0],
                step: 1,
                range: {
                    min: [0],
                    max: [50]
                },
                serialization: {
                    lower: [
                        $.Link({
                            target: $("#value-active-clients")
                        })
                    ],
                    format: {decimals: 0}
                }
            });

            $("#slider-tx-records").noUiSlider({
                start: [2],
                step: 1,
                range: {
                    min: [2],
                    max: [10]
                },
                serialization: {
                    lower: [
                        $.Link({
                            target: $("#value-tx-records")
                        })
                    ],
                    format: {decimals: 0}
                }
            });

            $("#slider-active-clients").change(function(){
                console.log($("#img-active-clients"));
                $("#img-active-clients").show();
                setTimeout(function() {
                    $("#img-active-clients").hide();
                }, 1000);
            });

            create_chart();
        }
        </script>
    </head>
    <body onload="init_demo()">

        <div style="position: absolute; left: 650px; top: 8px">
            Configuration:
            <p/>

            <span id="value-active-servers"></span> active servers
            <div id="slider-active-servers" style="width: 300px"></div>
            <p/>

            <span id="value-active-clients"></span> active clients
            <img id="img-active-clients" src="./loading.gif" style="display: none" width=12 height=12></img>
            <div id="slider-active-clients" style="width: 300px"></div>
            <p/>

            <span id="value-tx-records"></span> records per transaction
            <div id="slider-tx-records" style="width: 300px"></div>
        </div>

        Transactions per second (stacked <span style='color: #ff0000'>ABORT</span> + <span style='color: #00ff00'>COMMIT</span>):<p/>
        <canvas id="chart-tps" width="600" height="200"></canvas>
        <p/>
        Commit ratio:<p/>
        <canvas id="chart-ratio" width="600" height="200"></canvas>

    </body>
</html>
